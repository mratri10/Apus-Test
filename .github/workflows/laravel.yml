name: Laravel CI/CD

permissions:
  contents: read

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.5.4
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to Server via SSH
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e

          echo "üõ† Ensuring project directory exists..."
          mkdir -p ${{ secrets.DEPLOY_PATH }}
          cd ${{ secrets.DEPLOY_PATH }}

          if [ ! -d ".git" ]; then
            echo "üì¶ Cloning repo..."
            git clone git@github.com:${{ github.repository }} ./
          else
            echo "üîÑ Pulling latest code..."
            git pull origin main
          fi

          echo "üîê Writing .env file..."
          cat <<EOT > .env
          APP_NAME=Laravel
          APP_ENV=production
          APP_KEY=
          APP_DEBUG=false
          APP_URL=http://localhost:2601

          DB_CONNECTION=pgsql
          DB_HOST=127.0.0.1
          DB_PORT=5432
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          CACHE_DRIVER=file
          SESSION_DRIVER=file
          QUEUE_CONNECTION=sync
          EOT

          echo "üì¶ Installing PHP dependencies..."
          composer install --no-dev --optimize-autoloader

          echo "üî® Running Laravel setup..."
          php artisan config:clear
          php artisan config:cache
          php artisan key:generate
          php artisan migrate --force

          echo "‚öôÔ∏è Installing Node and building assets..."
          npm install
          npm run build

          echo "‚úÖ Deployment complete!"
        EOF
